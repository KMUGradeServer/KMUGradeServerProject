<!-- //////////////////////////////////////////
		fill every "here" sign using jinja2 template
		/////////////////////////////////////////// -->
		
{%- extends "main.html" -%}
{%- block body %}
<script>
var keys = ['courseId', 'userId', 'username', 
			 'college', 'department', 'authority'];
var placeholders = ['Course Id', 'ID', 'Name', 
					  'College', 'Department', 'Authority'];
var formsize = ['', 'small', 'mini', 'medium', 'medium', 'medium'];
$(function() {
	// To do.
	// now it shows all members having 'user' authority.
	// but if the member is exist, then it needs to change college/department/authority space automatically.
	var allUsers = [
		{%- for user, college, department in allUsers %}
		{ value: "{{ user.memberId }} {{ user.memberName }}", 
		data: "{{ user.memberId }} {{ user.memberName }} {{ college.collegeIndex }} {{ department.departmentIndex }} {{ department.departmentName }} {{ user.authority }}" },
		{% endfor -%}
		{ value: "", data: "" }
	];
	// autocompletion for initial state of the form
	$("#userId1").autocomplete({
		lookup: allUsers,
		onSelect: function(suggestion){
			var data = suggestion.data;
			var userId = data.split(" ")[0];
			var userName = data.split(" ")[1];
			var collegeIndex = data.split(" ")[2];
			var departmentIndex = data.split(" ")[3];
			var departmentName = data.split(" ")[4];
			var authority = data.split(" ")[5];
			
			if(authority.indexOf("COURSE_ADMINISTRATOR")!=-1){
				authority = 0;
			}
			else{
				authority = 1;
			}

			var userIdx = this.id.match(/(\d+)/g);
			
			document.getElementById(this.id).value = userId;
			document.getElementById("username"+userIdx).value = userName;
		
			// set predefined data
			document.getElementById("college"+userIdx).innerHTML =
				"<option selected>"+
					document.getElementById("college"+userIdx).options[collegeIndex].value+
				"</option>";
			document.getElementById("department"+userIdx).innerHTML =
				"<option selected>"+
					departmentIndex + ' '+ departmentName+
				"</option>";
			document.getElementById("authority"+userIdx).innerHTML =
				"<option selected>"+
					document.getElementById("authority"+userIdx).options[authority].value+
				"</option>";

			// for the exist data, set disabled option
			document.getElementById("college"+userIdx).setAttribute("disabled", "disabled");
			document.getElementById("department"+userIdx).setAttribute("disabled", "disabled");
			document.getElementById("authority"+userIdx).setAttribute("disabled", "disabled");
		}
	});

	$("#addline").bind('click',function(){
		var targetTable = document.getElementById('indivisual');
		var numOfRow = targetTable.rows.length;

		reset_val = function(){
			$("#courseId1").val("");
			$("#userId1").val("");
			$("#username1").val("");
			$("#college1").val("");
			$("#department1").val("");
			$("#authority1").val("");
		};

		var newRow = targetTable.insertRow(2);

		var memberIdOnFirstRow = $("#userId1").val(); // member Id before insert new row
		var isExistUser = false;

		{%- for user, college, department in allUsers %}
		if(memberIdOnFirstRow == "{{ user.memberId }}"){
			isExistUser = true;
		}
		{% endfor -%}

		for(var i = 0; i < targetTable.rows[0].cells.length; i++){  
			var uploadObj = "<td>";
			var selectedItem, index; 
			// course ID[0]
			if(i < 1){ 
				selectedItem = document.getElementById(keys[i]+"1");
				index = selectedItem.options[selectedItem.selectedIndex].index + 1;
				uploadObj += "<select id='" + keys[i] + numOfRow +
								      	"'name='" + keys[i] + numOfRow +
									  	"'value='" + $("#" + keys[i] + "1").val() +
									  	"'style='width:115px'>";
				{%- for ownCourse in ownCourses %}
				uploadObj += "<option";
				if(index == "{{ loop.index }}"){
					uploadObj += " selected";
				}
				uploadObj += ">{{ ownCourse.courseId }} {{ ownCourse.courseName }} </option>";
				{% endfor -%}
				uploadObj += "</select>";
			}
			// member ID[1], member name[2]
			else if(i < 3){
				uploadObj += "<input class='input-" + formsize[i] +
										"'id='" + keys[i] + numOfRow +
										"'name='" + keys[i] + numOfRow +
										"'type='text'" +
										"autocomplete='off'" +
										"placeholder='" + placeholders[i];
				// if the form is not empty then shows the value else shows placeholder
				var val = $("#"+keys[i]+"1").val();
				if(val != ""){
					uploadObj += "'value='" + val;
				}
				uploadObj += "'>";
			}
			// college[3], department[4], authority[5]
			else{
		    		uploadObj += "<select class='input-" + formsize[i] +
										"'id='" + keys[i] + numOfRow +
								      	"'name='" + keys[i] + numOfRow +
									  	"'value='" + $("#" + keys[i] + "1").val()+"'";
				if(isExistUser){
					uploadObj += " disabled";
				}
				uploadObj += ">";
				switch(i){
					// college
					case 3:
						var index = $("#" + keys[i] + "1 option:selected").text().match(/(\d+)/g);
			    			if(index == null){
			    				uploadObj += "<option> select college </option>";
			    			}
			    			{%- for college in allColleges %}
						uploadObj += "<option";
						if(index == "{{ college.collegeIndex }}"){
							uploadObj += " selected";
						}
						uploadObj += ">{{ college.collegeIndex }} {{ college.collegeName }} </option>";
						{% endfor -%}
						break;
					// department
					case 4:
						var collegeIndex = $("#" + keys[i-1] + "1 option:selected").text().match(/(\d+)/g);
			    			var departmentIndex = $("#" + keys[i] + "1 option:selected").text().match(/(\d+)/g);
			    			{%- for relation, collegeInfo, departmentInfo in allDepartments %}
			    				if("{{ relation.collegeIndex }}" == collegeIndex){
								uploadObj += "<option";
								if(departmentIndex == "{{ departmentInfo.departmentIndex }}"){
									uploadObj += " selected";
								}
								uploadObj += 
									">{{ departmentInfo.departmentIndex }} {{ departmentInfo.departmentName }}" +
									"</option>";
							}
						{% endfor -%}	
						break;
					// authority
					case 5:
						selectedItem = document.getElementById(keys[i]+"1");
						index = selectedItem.options[selectedItem.selectedIndex].index + 1;
						{%- for authority in authorities %}
						uploadObj += "<option";
						if(index == "{{ loop.index }}"){
							uploadObj += " selected";
						}
						uploadObj += ">{{ authority }} </option>";
						{% endfor -%}
						break;
				}
				uploadObj += "</select>";
			}
	    		newRow.insertCell(i).innerHTML = uploadObj;
		}

		$("#userId"+numOfRow).change(function(){
			var isExistUser = false;
			{%- for user, college, department in allUsers %}
				if($("#userId"+numOfRow).val() == "{{ user.memberId }}"){
					isExistUser = true;
				}
			{% endfor -%}
			if(!isExistUser){
				resetDisabledOption(numOfRow);
			}
		});

		$("#college"+numOfRow).change(function(){
			RowOnClickController(numOfRow);
		});

		// autocompletion for the form already exist
		$("#userId"+numOfRow).autocomplete({
			lookup: allUsers,
			onSelect: function(suggestion){
				var data = suggestion.data;
				var userId = data.split(" ")[0];
				var userName = data.split(" ")[1];
				var collegeIndex = data.split(" ")[2];
				var departmentIndex = data.split(" ")[3];
				var departmentName = data.split(" ")[4];
				var authority = data.split(" ")[5];
				
				if(authority.indexOf("COURSE_ADMINISTRATOR")!=-1){
					authority = 0;
				}
				else{
					authority = 1;
				}

				var userIdx = this.id.match(/(\d+)/g);
				
				document.getElementById(this.id).value = userId;
				document.getElementById("username"+userIdx).value = userName;

				var isExistUser = false;
				{%- for user, college, department in allUsers %}
				if(userId == "{{ user.memberId }}"){
					isExistUser = true;
				}
				{% endfor -%}

				if(isExistUser){
					// set predefined data and make it disabled
					document.getElementById("college"+userIdx).innerHTML =
						"<option selected>"+
							document.getElementById("college"+userIdx).options[collegeIndex].value+
						"</option>";
					document.getElementById("department"+userIdx).innerHTML =
						"<option selected>"+
							departmentIndex + ' '+ departmentName+
						"</option>";
					document.getElementById("authority"+userIdx).innerHTML =
						"<option selected>"+
							document.getElementById("authority"+userIdx).options[authority].value+
						"</option>";

					// set disabled option
					document.getElementById("college"+userIdx).setAttribute("disabled", "disabled");
					document.getElementById("department"+userIdx).setAttribute("disabled", "disabled");
					document.getElementById("authority"+userIdx).setAttribute("disabled", "disabled");
				}
			}
		});

		// initialization
		reset_val();
		document.getElementById("college1").removeAttribute("disabled");
		document.getElementById("department1").removeAttribute("disabled");
		document.getElementById("authority1").removeAttribute("disabled");

		var initialOptions = "<option> select college </option>" +
						   	   "{%- for college in allColleges %}" +
							   "<option>" +
						   	   "{{ college.collegeIndex }} {{ college.collegeName }}" +
						   	   "</option>" +
						   	   "{% endfor -%}";
		document.getElementById("college1").innerHTML = initialOptions;
		document.getElementById("department1").innerHTML = "";
	});

	$("#resetIndivisualUserForm").bind('click',function(){
		document.getElementById("indivisualUserForm").innerHTML = 
			'<td>' +
				'<select id="courseId1" name="courseId1" style="width:115px">' +
				  '{%- for ownCourse in ownCourses %}' +
				  '<option>' +
				  '{{ ownCourse.courseId }} {{ ownCourse.courseName }}' +
				  '</option>' +
				  '{% endfor -%}' +
			  '</select>' +
			'<td>' +
				'<input class="input-small formLine1" id="userId1" name="userId1"' +
							 'type="text" placeholder="ID" value="">' +
			'<td>' +
				'<input class="input-mini formLine1" id="username1" name="username1"' +
							 'type="text" placeholder="Name" value="">' +
			'<td>' +
				'<select class="input-medium" id="college1" name="college1">' +
					'<option> select college </option>' +
					'{%- for college in allColleges %}' +
					'<option>' +
					'{{ college.collegeIndex }} {{ college.collegeName }}' +
					'</option>' +
					'{% endfor -%}' +
				'</select>' +
			'<td>' +
				'<select class="input-medium" id="department1" name="department1">' +
				'</select>' +
			'<td>' +
				'<select class="input-medium" id="authority1" name="authority1">' +
					'{%- for authority in authorities %}' +
					'<option> {{ authority }} </option>' +
					'{% endfor -%}' +
				'</select>';

		$("#userId1").change(function(){
			var isExistUser = false;
			{%- for user, college, department in allUsers %}
				if($("#userId1").val() == "{{ user.memberId }}"){
					isExistUser = true;
				}
			{% endfor -%}
			if(!isExistUser){
				resetDisabledOption(1);
			}
		});

		$("#college1").change(function(){
			RowOnClickController(1);
		});

		$("#userId1").autocomplete({
			lookup: allUsers,
			onSelect: function(suggestion){
				var data = suggestion.data;
				var userId = data.split(" ")[0];
				var userName = data.split(" ")[1];
				var collegeIndex = data.split(" ")[2];
				var departmentIndex = data.split(" ")[3];
				var departmentName = data.split(" ")[4];
				var authority = data.split(" ")[5];
				
				if(authority.indexOf("COURSE_ADMINISTRATOR")!=-1){
					authority = 0;
				}
				else{
					authority = 1;
				}

				var userIdx = this.id.match(/(\d+)/g);
				
				document.getElementById(this.id).value = userId;
				document.getElementById("username"+userIdx).value = userName;

				// set predefined data and make it disabled
				document.getElementById("college"+userIdx).innerHTML =
					"<option selected>"+
						document.getElementById("college"+userIdx).options[collegeIndex].value+
					"</option>";
				document.getElementById("department"+userIdx).innerHTML =
					"<option selected>"+
						departmentIndex + ' '+ departmentName+
					"</option>";
				document.getElementById("authority"+userIdx).innerHTML =
					"<option selected>"+
						document.getElementById("authority"+userIdx).options[authority].value+
					"</option>";

				document.getElementById("college"+userIdx).setAttribute("disabled", "disabled");
				document.getElementById("department"+userIdx).setAttribute("disabled", "disabled");
				document.getElementById("authority"+userIdx).setAttribute("disabled", "disabled");
			}
		});
	});
});
</script>
<div class="container">
	<div>
		<h3>User addition</h3>
		<!--
		@@ Navigation for modal
		It matches each button to each modal.
		-->
		<div style="text-align:right">
			<a class="btn" href="#addUserModal" data-toggle="modal" role="button">
				Individual
			</a>
			<a class="btn" href="#addGroupModal" data-toggle="modal" role="button">
				Group
			</a>
			<a class="btn" data-toggle="modal" role="button" onclick="showingDeleteModal()">
				Delete
			</a>
		</div>
		<!-- End navigation -->

		<!--
		@@ Add user individually from modal
		 -->
		<form id="addIndivisualUser" method="post">
		<div class="modal hide fade" id="addUserModal"
			  aria-labelledby="addUserModalLabel" aria-hidden="false" role="dialog"
			  tabindex="-1" style="width:900px;margin-left:-450px">
			<div class="modal-header">
				<button class="close" type="button"
						  data-dismiss="modal" aria-hidden="true">x</button>
				<h3 id="addUserModalLabel">User addition</h3>
			</div>
			<div class="modal-body">
				<p>
					You can edit form data until you click 'Done'
				</p>
				<div style="text-align:right">
					<button class="btn" id="addline" type="button" >Add line</button>
				</div>
				<table class="table table-bordered" id="indivisual"
							 style="margin-top:10px">
					<thead>
						<tr>
							<td>Course
							<td>ID
							<td>Name
							<td>College
							<td>Department
							<td>Authority
					<tbody id="indivisualUserForm">
						<tr>
							<td>
								<select id="courseId1" name="courseId1" style="width:115px">
									{%- for ownCourse in ownCourses %}
									<option>
										{{ ownCourse.courseId }} {{ ownCourse.courseName }}
									</option>
									{% endfor -%}
								</select>
							<td>
								<input class="input-small formLine1" id="userId1" name="userId1"
										type="text" placeholder="ID" value="">
							<td>
								<input class="input-mini formLine1" id="username1" name="username1"
										type="text" placeholder="Name" value="">
							<td>
								<select class="input-medium" id="college1" name="college1">
									<option> select college </option>
									{%- for college in allColleges %}
									<option> 
										{{ college.collegeIndex }} {{ college.collegeName }}
									</option>
									{% endfor -%}
								</select>
							<td>
								<select class="input-medium" id="department1" name="department1">
								</select>
							<td>
								<select class="input-medium" id="authority1" name="authority1">
									{%- for authority in authorities %}
									<option> {{ authority }} </option>
									{% endfor -%}
								</select>
				</table>
			</div>
			<div class="modal-footer">
				<button class="btn" name="addIndivisualUser" onclick="activateDisabledOption();">Done</button>
				<button class="btn" id="resetIndivisualUserForm"
						  data-dismiss="modal" aria-hidden="true">Close</button>
			</div>
		</div>
		</form>
		<!-- End add user individually modal -->

		<!-- 
		@@ Add user group modal 
		-->
		<div class="modal hide fade" id="addGroupModal"
			  aria-labelledby="addGroupModalLabel" aria-hidden="true"
			  role="dialog" tabindex="-1">
			<!--
			@@ Add user from files
			It allows multiple files to upload.
			Before you push 'Done', make sure you select correct course and the files' contents are suit to the manual.
			-->
			<form method="post" enctype="multipart/form-data">
				<div class="modal-header">
					<button class="close" data-dismiss="modal"
									type="button" aria-hidden="true">x</button>
					<h3 id="addGroupModalLabel">User Addition</h3>
				</div>
				<div class="modal-body">
					<p>
						Authority will be set '<b>USER(student)</b>'<br>
						File contents should be like the form below<br>
						<b>userId=user_bot1, username=test_user, college=1, department=1</b><br>
						<div style="width:120px;display:inline-block;text-align:center">Course</div>
						<select id="courseId" name="courseId" style="display:inline-block">
						{%- for ownCourse in ownCourses %}
						<option>
							{{ ownCourse.courseId }} {{ ownCourse.courseName }}
						</option>
						{% endfor -%}
						</select><br>
						<div style="width:120px;display:inline-block;text-align:center;margin-left:-1px">
						File(*.txt, *.csv)
						</div>
						<input type="file" name="files" multiple>
					</p>
				</div>
				<div class="modal-footer">
					<button class="btn" name="addUserGroup" type="submit">
						Done
					</button>
					<button class="btn" data-dismiss="modal" aria-hidden="true">
						Close
					</button>
				</div>
			</form>
			<!-- @@ End user from files -->
		</div>
		<!-- @@ End user group modal -->

		<!--
		@@ Holding user list
		When you check users and click 'Delete', it sends checked values to server.
		-->
		<table class="table table-bordered" id="pendingUserTable" style="margin-top:10px">
			<thead>
				<tr>
					<td>Index
					<td>ID
					<td>Name
					<td>Authority
					<td>College
					<td>Department
					<td>Check <input class="checkAll" type="checkbox" style="margin:0px" onclick="selectAllCheckboxes('pendingUserTable');">
			<tbody>
<form method="post">
				<script> index = 0; </script>
				{%- for newUser in newUsers %}
				<tr>
					<td><script> document.write(++index); </script>
					<td>{{ newUser[0] }}
					<td>{{ newUser[1] }}
					<td>{% if newUser[2]==SETResources.const.USER %}Student{% else %}{{ newUser[2] }}{% endif %}
					<td>{{ newUser[4] }}
					<td>{{ newUser[6] }}
					<td>
						<label class="checkbox-center">
							<input class="box-check" name="{{ newUser[0] }}"
									type="checkbox" value="{{ newUser[0] }}">
						</label>
				{% endfor -%}
		</table>
		<a href="{{ url_for('GradeServer.server_add_user') }}">
			<button class="btn" name="addUser" type="submit">Done</button>
		</a>
	</div>
		<!-- End holding user list -->

		<!-- 
		@@ Delete holding users modal
		It works when you click 'Delete' then shows pop-up.
		-->
		<div class="modal hide fade" id="deleteModal"
			  aria-labelledby="deleteModalLabel" aria-hidden="true"
			  role="dialog" tabindex="-1">
			<div class="modal-header">
				<button class="close" data-dismiss="modal"
								type="button" aria-hidden="true">x</button>
				<h3 id="deleteModalLabel">User deletion</h3>
			</div>
			<div class="modal-body">
				<p>Do you really want to delete it?</p>
			</div>
			<div class="modal-footer">
					<button class="btn" name="deleteUser" type="submit">
						Confirm
					</button>
					<button class="btn" data-dismiss="modal" aria-hidden="true">
						Close
					</button>
</form>
			</div>
		</div>
		<div class="modal hide fade" id="deleteNoItem"
				 aria-labelledby="deleteModalLabel" aria-hidden="true"
				 role="dialog" tabindex="-1">
			<div class="modal-header">
				<button class="close" type="button"
								data-dismiss="modal" aria-hidden="true">x</button>
				<h3 id="deleteModalLabel">User deletion</h3>
			</div>
			<div class="modal-body">
				<p>No items choosed</p>
			</div>
			<div class="modal-footer">
				<button class="btn" data-dismiss="modal" aria-hidden="true">
					Close
				</button>
			</div>
		</div>
		<!-- @@ End delete user modal -->
</div>
<script>
$("#userId1").change(function(){
	var isExistUser = false;
	{%- for user, college, department in allUsers %}
		if($("#userId1").val() == "{{ user.memberId }}"){
			isExistUser = true;
		}
	{% endfor -%}
	if(!isExistUser){
		resetDisabledOption(1);
	}
});

function resetDisabledOption(idxOfRow){
	// reset diabled option
	document.getElementById("college"+idxOfRow).removeAttribute("disabled");
	document.getElementById("department"+idxOfRow).removeAttribute("disabled");
	document.getElementById("authority"+idxOfRow).removeAttribute("disabled");

	document.getElementById("college"+idxOfRow).innerHTML = 
		'<option> select college </option>' +
		'{%- for college in allColleges %}' +
		'<option>' +
		'{{ college.collegeIndex }} {{ college.collegeName }}' +
		'</option>' +
		'{% endfor -%}';
	document.getElementById("department"+idxOfRow).innerHTML =
		'<select class="input-medium" id="department"'+idxOfRow+' name="department'+idxOfRow+'">' +
		'</select>';
	document.getElementById("authority"+idxOfRow).innerHTML =
		'<select class="input-medium" id="authority'+idxOfRow+'" name="authority'+idxOfRow+'">' +
		'{%- for authority in authorities %}' +
		'<option> {{ authority }} </option>' +
		'{% endfor -%}' +
		'</select>';
}

function activateDisabledOption(){
	var selectForms = document.getElementsByTagName("select");
	for(var i=0;i<selectForms.length;i++){
		if(selectForms[i].disabled == true){
			selectForms[i].disabled = false;
		}
	}
	document.getElementById("addIndivisualUser").submit();
}

$("#college1").change(function(){
	RowOnClickController(1);
});

function RowOnClickController(IdxOfRow){
	var selectedText = $("#college"+IdxOfRow+" option:selected").text();

	selectedText = selectedText.replace(/\t|\n/g, "");
	
	var index = selectedText.match(/\d+/g);
	var name = selectedText.split(index)[1];

	var initialOptions = document.getElementById("college"+IdxOfRow).innerHTML;

	if(initialOptions.indexOf("select college") != -1){
		var OptionsWithoutDefault = 
			initialOptions.replace("<option> select college </option>", "");
		
		// remove tab spaces
		OptionsWithoutDefault = OptionsWithoutDefault.replace(/\t/g, "");

		// split for checking selected value
		OptionsWithoutDefault = OptionsWithoutDefault.split('</option>');

		var newOptions = "";
		for(var i=0;i<OptionsWithoutDefault.length;i++){
			// if an option's index and name are same then gives 'selected'
			if(OptionsWithoutDefault[i].indexOf(index+name) != -1){
				OptionsWithoutDefault[i] = OptionsWithoutDefault[i].replace("<option>", "<option selected>");
			}
			newOptions += OptionsWithoutDefault[i] + ' ';
		}
		document.getElementById("college"+IdxOfRow).innerHTML = newOptions;
	}
	{%- for college in allColleges %}
	if(index == "{{ college.collegeIndex }}"){
		document.getElementById("department"+IdxOfRow).innerHTML = "";
		{%- for relation, collegeInfo, departmentInfo in allDepartments %}
			{%- if relation.collegeIndex == college.collegeIndex %}
			document.getElementById("department"+IdxOfRow).innerHTML += 
				"<option>" +
				"{{ departmentInfo.departmentIndex }} {{ departmentInfo.departmentName }}" +
				"</option>";
			{% endif -%}
		{% endfor -%}
	}
	{% endfor -%}
}


</script>
{% endblock -%}